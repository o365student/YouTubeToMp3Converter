@{
    ViewData["Title"] = "YouTube 轉 MP3";
}

<h2 class="mb-3">YouTube 轉 MP3</h2>
<h3 class="mb-3">皮卡綸專用</h3>

<div class="mb-3">
    <input id="url" class="form-control" placeholder="https://youtu.be/..." />
</div>

<button id="btn" class="btn btn-primary">下載</button>

<!-- 進度條 -->
<div class="progress mt-4" style="height:25px; display:none;">
    <div id="bar" class="progress-bar" role="progressbar"
         style="width:0%">
        0%
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $('#btn').on('click', async () => {
        const url = $('#url').val();
        if (!url) { alert('請輸入網址'); return; }

        // 1️⃣  送 /Start 取得 jobId
        const fd = new FormData();
        fd.append('url', url);
        const res = await fetch('/Home/Start', { method:'POST', body:fd });
        if (!res.ok) { alert(await res.text()); return; }
        const { jobId, title } = await res.json();

        $('.progress').show();
        $('#bar').text('0%').css('width','0%');

        // 2️⃣  接進度
        const es = new EventSource(`/Home/Progress?jobId=${jobId}`);
        es.onmessage = e => {
            const pct = parseFloat(e.data);
            $('#bar').css('width', `${pct}%`).text(`${pct.toFixed(0)}%`);
        };
        es.addEventListener('complete', e => {
            es.close();
            $('#bar').css('width', '100%').text('100%');
            alert('✔ 下載完成！');

            // 3️⃣  自動觸發檔案下載
            window.location = `/Home/File?jobId=${jobId}`;
        });
        es.addEventListener('error', e => {
            es.close();
            alert('❌ 失敗：' + e.data);
        });
    });
</script>
